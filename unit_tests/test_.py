

Responses = [
    {
        "Object": 1,
        "ID": "00a4917b-e25f-43da-9771-bc4cf742c3ec",
        "Question": "where is the help desk for tech issues",
        "Answer": "The Help Desk for tech issues is located above the fitness center. You can also create a Help Desk ticket using their portal or by emailing support@hhmi.org.",
        "Response Notes": "Check for email support@hhmi.org",
        "Source Notes": "Wiki: Getting Help (https://wikis.janelia.org/display/SCSW/Getting+Help)",
        "Context":[
            "For assistance with computer, network, or phone issues, you can create a Help Desk ticket either by using their portal or by emailing support@hhmi.org.", 
            "Additionally, you can visit the Help Desk in person, which is located above the fitness center.", 
            "To get there, walk out the main doors and go across to the hotel.", 
        ]
    },
    {
        "Object": 4,
        "ID": "024cf273-1920-43cb-a7e8-c3191af81c59",
        "Question": "Where do i go if i need tech help at janelia",
        "Answer": "If you need tech help at Janelia, you should create a Help Desk ticket either by using their portal or by emailing support@hhmi.org. You can also walk over to the Help Desk, which is located above the fitness center.",
        "Response Notes": "Look for help desk and support@hhmi.org",
        "Source Notes": "Wiki: Getting Help (https://wikis.janelia.org/display/SCSW/Getting+Help)",
        "Context": ["For assistance with computer, network, or phone issues, you can create a Help Desk ticket either by using their portal or by emailing support@hhmi.org.", 
            "Additionally, you can visit the Help Desk in person, which is located above the fitness center.", 
            "To get there, walk out the main doors and go across to the hotel."
        ]
    },
    {
        "Object": 6,
        "ID": "02e95fd0-fbfc-461b-bec9-7bb1278ba7bb",
        "Question": "What is mdas",
        "Answer": "MDAS stands for \"microscope direct attached storage.\" It is a specialized storage system designed to handle high-speed data capture from microscopes, providing a distributed and shared storage solution. The system includes a tiered storage approach with SSDs for incoming writes and larger spinning disk pools for long-term storage.",
        "Response Notes": "None",
        "Source Notes": "Wiki: Check if a Source points to a 11:44 slack message in #storage",
        "Context": ["MDAS stands for 'microscope direct attached storage.' It is a storage system designed to handle high-speed data capture directly from microscopes.", 
    "The system includes a tiered storage approach, with an SSD tier for incoming writes to avoid bottlenecks and a larger spinning disk pool for longer-term storage.", 
    "This setup allows for efficient data management and transfer, although it may require expansion to sustain higher data rates and concurrent access."]
    },
    {
        "Object": 13,
        "ID": "0d0fad42-ba6a-4223-8bd2-2e58554d51cb",
        "Question": "what slack channels should i join if i'm new",
        "Answer": "You might want to join channels like #slack-best-practices for questions, answers, and useful tips, as well as other interesting channels that you can find by clicking the '+' next to \"Channels\" and choosing \"Browse channels.\"",        
        "Response Notes": "Completely misleading response and we dont know why. Should mention python according to sources",
        "Source Notes": "NA",
        "Context": ["If you're new at Janelia, you might want to explore and join various Slack channels to get integrated into the community.", 
    "You can click the '+' next to 'Channels' and choose 'Browse channels' to see all available options.", 
    "Additionally, channels related to Janelia-Software and other public channels within the HHMI workspace are accessible to anyone at Janelia.", 
    "If you encounter any issues joining a channel, you can contact Donald Olbris for assistance."]
    },
    {
        "Object": 25,
        "ID": "189988ac-433e-4640-9684-5c46f40e54b5",
        "Question": "Who knows the most about julia?",
        "Answer": "Mark Kittisopikul appears to know the most about Julia, as he has shared multiple resources and information about the programming language.",
        "Response Notes": "Only mentions one of two strong julia programmers",
        "Source Notes": "NA",
        "Context": ["Mark Kittisopikul and Ben Arthur appear to have significant knowledge about Julia at Janelia.", 
    "Mark has shared resources and insights about Julia, while Ben has historically used it for scientific computing.", ]
    },
    {
        "Object": 41,
        "ID": "2fa07b48-9130-458d-a38f-ae4860a901e3",
        "Question": "how do I get help from cryoem?",
        "Answer": "To get help from the CryoEM facility, you need to contact the facility to initiate the registration process. Once registered, you can use their online scheduler to book equipment time if you have ready-to-image cryo grids. If you need more assistance, have technical questions, or want to initiate a collaboration, you can contact the facility director, Dr. Zhiheng Yu, at yuz10@janelia.hhmi.org, or email cryoemfacility@janelia.hhmi.org.",
        "Response Notes": "Includes yuz10@janelia.hhmi.org or cryoemfacility@janelia.hhmi.org",
        "Source Notes": "first source should be \"Web: Cryo-Electron Microscopy\"",
        "Context": [   
    "You should contact the facility to initiate the registration process.", 
    "Once registered, you can use the online scheduler to book equipment time if you have ready-to-image cryo grids.", 
    "If you need more assistance, have technical questions, or want to initiate a collaboration, you can contact the facility director, Dr. Zhiheng Yu, or email the facility directly.", 
    "The facility offers a range of services, including high-quality data collection, cryo FIB milling, and collaboration on various aspects of the cryoEM workflow.", 
    "Make sure to review the policies and instructions before reserving equipment time or sending any shipments.", ]
    },
    {
        "Object": 49,
        "ID": "38af623d-35d3-48ab-8587-a40aa8d2694b",
        "Question": "who are the group leaders in 4DCP?",
        "Answer": "The group leaders in 4D Cellular Physiology (4DCP) are outstanding scientists who lead laboratories developing new tools or methods or bringing innovative approaches to the study of biological problems within Janelia's research areas. They are passionate about conducting research in various scientific areas, including cell biological mechanisms of development, cytoskeleton and signaling processes in tissues, deep tissue and intravital imaging, and more. These leaders are typically late-stage graduate students, postdoctoral associates, or early-career faculty members enthusiastic about taking charge of a small lab in a collaborative environment.",
        "Response Notes": "Does not return any specific people",
        "Source Notes": "Will not work until we segment over the 4DCP website in the future",
        "Context": ["The group leaders in 4D Cellular Physiology (4DCP) are: JENNIFER LIPPINCOTT-SCHWARTZ, Head of 4D Cellular Physiology; MISHA AHRENS, Senior Group Leader; MENG WANG, Senior Group Leader; ISABEL ESPINOSA MEDINA, Group Leader; ANOJ ILANGES, Group Leader; JIEFU LI, Group Leader; YIN LIU, Group Leader; ALLYSON SGRO, Group Leader; ALLYSON SGRO, Group Leader.", ]
    },
    {
        "Object": 50,
        "ID": "38af623d-35d3-48ab-8587-a40aa8d2694b",
        "Question": "what is neuronbridge",
        "Answer": "NeuronBridge is a web application designed to facilitate the search for morphological matches between large data sets of neurons imaged using different modalities. It is particularly useful in neuroscience research involving Drosophila, where it helps researchers find similar neurons across various imaging techniques, such as electron microscopy and confocal light microscopy. The application features a user-friendly graphical interface, an extensible data model, a serverless cloud architecture, and a highly parallel image search engine. It supports the integration and reuse of its software code, open APIs, and processed data sets, and is available as a service to the neuroscience research community.",
        "Response Notes": "This current response is great, use it as baseline",
        "Source Notes": "Main source isn't very helpful (Wiki: NeuronBridge) only had links, future if we sort by content of the website and link name",
        "Context": [ "NeuronBridge is a project developed at Janelia that provides a platform for managing and searching neuron imagery.", 
    "It includes a front-end website and back-end AWS services, and it supports color depth searches.", 
    "The platform is designed to handle various stages of development, including production, internal pre-release, and validation.", 
    "It also utilizes multiple AWS S3 buckets for storing metadata, precomputed search JSON files, and web content.",
    "The project is actively maintained with source control repositories available on GitHub for different components of the system.",]
    },
    {
        "Object": 54,
        "ID": "3afec7cb-9a93-478f-ae0b-fa1815f57395",
        "Question": "how many people are there in Misha Arhens lab?",
        "Answer": "There are 18 people in Misha Ahrens' lab.",
        "Response Notes": "There are not 18 people in the lab. Check with the data in ./data. Also, paste website content into gpt and ask the same question",
        "Source Notes": "N/A",
        "Context": ["There are 7 members in the Misha Arhens lab team, 2 visiting scientists in residence, 11 other science contributors, and 1 lab coordinator"]
    }
]

import deepeval
from deepeval import assert_test
from deepeval.test_case import LLMTestCase
from deepeval.metrics import HallucinationMetric, AnswerRelevancyMetric
from deepeval.dataset import EvaluationDataset
import pytest
from generate_answer import SemanticSearchService
from generate_source import SemanticSearchServiceSources
weaviate_url = "http://localhost:8777"
service_src = SemanticSearchServiceSources(weaviate_url)
service_ans = SemanticSearchService(weaviate_url)

# true -> pass
# false -> fail
def custom_checking(Responses):
    data_list = [] 
    test_cases = {}
    for response in Responses:
        input_question = response['Question']
        actual_output = service_ans.generate_response(input_question)
        actual_sources = service_src.generate_response(input_question)
        current_id = response['ID']
        data_list.append([input_question, actual_output, actual_sources, current_id])

        if(current_id == "00a4917b-e25f-43da-9771-bc4cf742c3ec"):
            test_cases[current_id] = "support@hhmi.org" in actual_output and "https://wikis.janelia.org/display/SCSW/Getting+Help" in actual_sources
        elif(current_id == "024cf273-1920-43cb-a7e8-c3191af81c59"):
            test_cases[current_id] = "help desk" in actual_output and "support@hhmi.org" in actual_output and "https://wikis.janelia.org/display/SCSW/Getting+Help" in actual_sources
        elif current_id == "02e95fd0-fbfc-461b-bec9-7bb1278ba7bb":
            test_cases[current_id] = "11:44 slack message in #storage" in actual_sources
        elif current_id == "0d0fad42-ba6a-4223-8bd2-2e58554d51cb":
            test_cases[current_id] = "python" in actual_output
        elif current_id == "189988ac-433e-4640-9684-5c46f40e54b5":
            test_cases[current_id] = "Mark Kittisopikul" in actual_output and "Ben Arthur" in actual_output
        elif current_id == "2fa07b48-9130-458d-a38f-ae4860a901e3":
            test_cases[current_id] = ("yuz10@janelia.hhmi.org" in actual_output or "cryoemfacility@janelia.hhmi.org" in actual_output) and "Cryo-Electron Microscopy" in actual_sources
        elif current_id == "38af623d-35d3-48ab-8587-a40aa8d2694b":
            test_cases[current_id] = "JENNIFER LIPPINCOTT-SCHWARTZ" in actual_output
        elif current_id == "3afec7cb-9a93-478f-ae0b-fa1815f57395":
            test_cases[current_id] = ("21" in actual_output or "20" in actual_output or "9" in actual_output or "7" in actual_output)
    #print("\n\n",data_list)
    
    return test_cases, data_list
#print(custom_checking(Responses))
test_cases, data_list = custom_checking(Responses)

def print_test_results(test_cases, data_list):
    for test_id, result in test_cases.items():
        # Find the corresponding data sublist
        for data in data_list:
            if data[-1] == test_id:
                # Extract details
                actual_output, actual_sources, current_id = data[1], data[2], data[3]
                # Print test result
                test_result = "PASSED" if result else "FAILED"
                print(f"Test Case ID: {test_id} - {test_result}")
                print(f"Actual Output: {actual_output}")
                print(f"Actual Sources: {actual_sources}")
                print(f"Current ID: {current_id}\n")

# Call the function with the sample data
print_test_results(test_cases, data_list)


# Soft semanic-distance based unit test
def create_test_cases(Responses):
    test_cases = []
    for response in Responses:
        input_question = response['Question']
        #             = service.generate_response(input_question)  # Assuming generate_response can take context
        actual_output = service_ans.generate_response(input_question)
        context = response['Context']  # Extract context and make it a list

        test_case = LLMTestCase(
            input=input_question,
            actual_output=actual_output,
            context=context,  # Pass context here
            # custom_check = custom_check,
        )
        test_cases.append(test_case)
    return test_cases

dataset = EvaluationDataset(test_cases=create_test_cases(Responses))

# Decorator asserts a test every time the test_customer_chatbot function is run
@pytest.mark.parametrize(
    "test_case",
    dataset,
)
def test_customer_chatbot(test_case: LLMTestCase):
    # Be weary of the hallucination_metric because it is calculated by dividing the number of contradicted contexts and the total number of contexts. There is only one context at the moment
    hallucination_metric = HallucinationMetric(threshold=0.75, model="gpt-3.5-turbo")

    # answer_relevancy_metric = Number of statements that are relevant to the question / Total number of statements. 
    answer_relevancy_metric = AnswerRelevancyMetric(threshold=0.5, model="gpt-3.5-turbo")
    assert_test(test_case,  [hallucination_metric, answer_relevancy_metric])




